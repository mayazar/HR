import React, { useState, useEffect, useRef } from 'react';
import { 
  Users, 
  UserCheck, 
  Calendar, 
  GraduationCap, 
  Search, 
  Settings, 
  Plus, 
  ChevronRight, 
  ChevronLeft,
  FileSpreadsheet,
  Mail,
  Phone,
  Briefcase
} from 'lucide-react';

// --- קונפיגורציה ---
// כאן תכניס את ה-ID של הגיליון שלך לאחר פרסומו ל-Web כ-CSV
const SHEET_ID = ""; 
const DEFAULT_AVATAR = "https://images.unsplash.com/photo-1544717297-fa154da09f9d?w=150&h=150&fit=crop";

const App = () => {
  const [staff, setStaff] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedMember, setSelectedMember] = useState(null);

  // פונקציה לייבוא נתונים מגוגל שיטס
  const fetchData = async () => {
    setLoading(true);
    try {
      // אם יש SHEET_ID, נמשוך ממנו. אם לא, נשתמש בנתוני דמו מקצועיים.
      if (SHEET_ID) {
        const response = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
        const text = await response.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const rows = json.table.rows.map(row => ({
          id: row.c[0]?.v || Math.random(),
          name: row.c[1]?.v || '',
          role: row.c[2]?.v || '',
          department: row.c[3]?.v || '',
          status: row.c[4]?.v || 'Active',
          phone: row.c[5]?.v || '',
          email: row.c[6]?.v || '',
          image: row.c[7]?.v || DEFAULT_AVATAR,
          seniority: row.c[8]?.v || 0
        }));
        setStaff(rows);
      } else {
        // נתוני דמו לצרכי תצוגה
        const demoData = [
          { id: 1, name: "ד״ר רחל לוי", role: "מנהלת פדגוגית", department: "הנהלה", status: "Active", email: "rachel@school.edu", phone: "052-1234567", image: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=150", seniority: 15 },
          { id: 2, name: "יוסי כהן", role: "רכז שכבת י'", department: "מורים", status: "Active", email: "yossi@school.edu", phone: "050-7654321", image: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150", seniority: 8 },
          { id: 3, name: "מיכל אברהם", role: "יועצת חינוכית", department: "ייעוץ", status: "On Leave", email: "michal@school.edu", phone: "054-9876543", image: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150", seniority: 12 },
          { id: 4, name: "אביב מזרחי", role: "מורה למתמטיקה", department: "מורים", status: "Active", email: "aviv@school.edu", phone: "053-1112233", image: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=150", seniority: 5 },
          { id: 5, name: "שרה גולדנברג", role: "מזכירת בית ספר", department: "מנהלה", status: "Active", email: "sarah@school.edu", phone: "058-4445566", image: "https://images.unsplash.com/photo-1554151228-14d9def656e4?w=150", seniority: 20 },
          { id: 6, name: "דניאל פרץ", role: "מורה לחינוך גופני", department: "מורים", status: "Active", email: "danny@school.edu", phone: "052-9988776", image: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150", seniority: 3 },
        ];
        setStaff(demoData);
      }
    } catch (error) {
      console.error("Error fetching data:", error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  const filteredStaff = staff.filter(member => 
    (activeTab === 'all' || member.department === activeTab) &&
    (member.name.includes(searchTerm) || member.role.includes(searchTerm))
  );

  const stats = {
    total: staff.length,
    active: staff.filter(s => s.status === 'Active').length,
    leave: staff.filter(s => s.status === 'On Leave').length,
    seniors: staff.filter(s => s.seniority > 10).length
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans rtl text-right" dir="rtl">
      {/* Sidebar Navigation */}
      <aside className="fixed right-0 top-0 h-full w-20 bg-indigo-900 text-white flex flex-col items-center py-8 gap-8 z-50">
        <div className="bg-orange-500 p-3 rounded-2xl shadow-lg mb-4">
          <GraduationCap size={28} />
        </div>
        <nav className="flex flex-col gap-6">
          <button className="p-3 hover:bg-white/10 rounded-xl transition-colors text-orange-300"><Users size={24} /></button>
          <button className="p-3 hover:bg-white/10 rounded-xl transition-colors"><Calendar size={24} /></button>
          <button className="p-3 hover:bg-white/10 rounded-xl transition-colors"><FileSpreadsheet size={24} /></button>
          <button className="p-3 hover:bg-white/10 rounded-xl transition-colors"><Settings size={24} /></button>
        </nav>
      </aside>

      {/* Main Content Area */}
      <main className="mr-20 p-8">
        
        {/* Header Section */}
        <header className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
          <div>
            <h1 className="text-3xl font-bold text-slate-800">ניהול הון אנושי</h1>
            <p className="text-slate-500 mt-1">בית הספר "נתיבי דעת" - לוח בקרה מרכזי</p>
          </div>
          
          <div className="flex items-center gap-4">
            <div className="relative">
              <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
              <input 
                type="text" 
                placeholder="חיפוש עובד/ת..." 
                className="pr-10 pl-4 py-2 bg-white border border-slate-200 rounded-full w-64 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />
            </div>
            <button className="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-full flex items-center gap-2 transition-all shadow-md active:scale-95">
              <Plus size={18} />
              <span>הוספת עובד</span>
            </button>
          </div>
        </header>

        {/* Stats Section */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
          <StatCard icon={<Users className="text-indigo-600" />} label="סה״כ עובדים" value={stats.total} color="bg-indigo-100" />
          <StatCard icon={<UserCheck className="text-green-600" />} label="נוכחים היום" value={stats.active} color="bg-green-100" />
          <StatCard icon={<Calendar className="text-orange-600" />} label="בחופשה/מחלה" value={stats.leave} color="bg-orange-100" />
          <StatCard icon={<GraduationCap className="text-purple-600" />} label="וותק 10+ שנים" value={stats.seniors} color="bg-purple-100" />
        </div>

        {/* Filters and Scroller Sections */}
        <div className="mb-6">
          <div className="flex gap-4 overflow-x-auto pb-4 no-scrollbar">
            {['all', 'הנהלה', 'מורים', 'ייעוץ', 'מנהלה'].map(tab => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-6 py-2 rounded-full font-medium transition-all whitespace-nowrap shadow-sm ${
                  activeTab === tab 
                  ? 'bg-indigo-600 text-white' 
                  : 'bg-white text-slate-600 hover:bg-slate-100'
                }`}
              >
                {tab === 'all' ? 'כל הצוות' : tab}
              </button>
            ))}
          </div>
        </div>

        {/* Dynamic Staff Scroller (Carousel) */}
        <div className="relative group">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-slate-700">כרטיסי עובדים</h2>
            <div className="flex gap-2">
              <button onClick={() => scroll('left')} className="p-2 bg-white rounded-full shadow hover:bg-slate-50 transition-colors"><ChevronRight size={20}/></button>
              <button onClick={() => scroll('right')} className="p-2 bg-white rounded-full shadow hover:bg-slate-50 transition-colors"><ChevronLeft size={20}/></button>
            </div>
          </div>
          
          <div 
            id="staff-container"
            className="flex gap-6 overflow-x-auto pb-8 snap-x no-scrollbar scroll-smooth"
          >
            {loading ? (
              <div className="w-full flex justify-center py-20">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
              </div>
            ) : filteredStaff.length > 0 ? (
              filteredStaff.map(member => (
                <StaffCard 
                  key={member.id} 
                  member={member} 
                  onClick={() => setSelectedMember(member)} 
                />
              ))
            ) : (
              <div className="w-full text-center py-20 text-slate-400 font-medium">לא נמצאו תוצאות לחיפוש זה.</div>
            )}
          </div>
        </div>

        {/* Member Details Modal */}
        {selectedMember && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl w-full max-w-2xl overflow-hidden shadow-2xl animate-in zoom-in-95 duration-200">
              <div className="relative h-32 bg-gradient-to-l from-indigo-600 to-purple-600">
                <button 
                  onClick={() => setSelectedMember(null)}
                  className="absolute left-4 top-4 bg-white/20 hover:bg-white/40 text-white rounded-full p-2"
                >
                  <ChevronLeft size={20} />
                </button>
              </div>
              <div className="px-8 pb-8 -mt-12">
                <div className="flex items-end gap-6 mb-6">
                  <img src={selectedMember.image} className="w-32 h-32 rounded-2xl border-4 border-white shadow-lg object-cover" />
                  <div className="pb-2">
                    <h3 className="text-2xl font-bold text-slate-800">{selectedMember.name}</h3>
                    <p className="text-indigo-600 font-medium">{selectedMember.role}</p>
                  </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                  <DetailItem icon={<Briefcase size={18} />} label="מחלקה" value={selectedMember.department} />
                  <DetailItem icon={<Calendar size={18} />} label="וותק" value={`${selectedMember.seniority} שנים`} />
                  <DetailItem icon={<Mail size={18} />} label="דוא״ל" value={selectedMember.email} />
                  <DetailItem icon={<Phone size={18} />} label="טלפון" value={selectedMember.phone} />
                </div>
                
                <div className="mt-8 pt-6 border-t border-slate-100 flex justify-end">
                  <button 
                    onClick={() => setSelectedMember(null)}
                    className="px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-full font-medium transition-colors"
                  >
                    סגור
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </main>

      <style>{`
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `}</style>
    </div>
  );

  function scroll(direction) {
    const container = document.getElementById('staff-container');
    const scrollAmount = 400;
    container.scrollBy({
      left: direction === 'right' ? -scrollAmount : scrollAmount,
      behavior: 'smooth'
    });
  }
};

const StatCard = ({ icon, label, value, color }) => (
  <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-shadow">
    <div className={`p-3 rounded-2xl ${color}`}>
      {icon}
    </div>
    <div>
      <p className="text-slate-500 text-sm font-medium">{label}</p>
      <p className="text-2xl font-bold text-slate-800">{value}</p>
    </div>
  </div>
);

const StaffCard = ({ member, onClick }) => (
  <div 
    onClick={onClick}
    className="min-w-[280px] bg-white rounded-3xl p-6 shadow-sm border border-slate-100 snap-start cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all group"
  >
    <div className="relative mb-4">
      <img 
        src={member.image} 
        alt={member.name} 
        className="w-20 h-20 rounded-2xl object-cover shadow-md group-hover:ring-4 ring-indigo-100 transition-all" 
      />
      <div className={`absolute -bottom-1 -right-1 w-5 h-5 rounded-full border-2 border-white ${
        member.status === 'Active' ? 'bg-green-500' : 'bg-orange-500'
      }`}></div>
    </div>
    <h3 className="text-lg font-bold text-slate-800 mb-1">{member.name}</h3>
    <p className="text-sm text-indigo-600 font-medium mb-3">{member.role}</p>
    
    <div className="flex items-center gap-2 text-xs text-slate-400 bg-slate-50 p-2 rounded-xl">
      <Briefcase size={14} />
      <span>{member.department}</span>
      <span className="mx-1">•</span>
      <span>{member.seniority} שנ׳ וותק</span>
    </div>
  </div>
);

const DetailItem = ({ icon, label, value }) => (
  <div className="flex items-center gap-3">
    <div className="p-2 bg-slate-50 rounded-lg text-slate-400">
      {icon}
    </div>
    <div>
      <p className="text-xs text-slate-500">{label}</p>
      <p className="text-slate-700 font-medium">{value}</p>
    </div>
  </div>
);

export default App;
